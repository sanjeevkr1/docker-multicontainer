name: Deploy to Elastic Beanstalk
on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (commit SHA) to deploy'
        required: false
        default: 'latest'
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if the build workflow succeeded or if manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set image tag
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create docker-compose override for production
        run: |
          cat > docker-compose.prod.yml << 'EOF'
          version: '3'
          services:
            postgres:
              image: 'postgres:latest'
              environment:
                - POSTGRES_PASSWORD=postgres_password
            redis:
              image: 'redis:latest'
            nginx:
              image: ${{ secrets.DOCKER_USERNAME }}/my-nginx:${{ steps.set_tag.outputs.tag }}
              ports:
                - '80:80'
            api:
              image: ${{ secrets.DOCKER_USERNAME }}/my-api:${{ steps.set_tag.outputs.tag }}
              environment:
                - REDIS_HOST=redis
                - REDIS_PORT=6379
                - PGUSER=postgres
                - PGHOST=postgres
                - PGDATABASE=postgres
                - PGPASSWORD=postgres_password
                - PGPORT=5432
            client:
              image: ${{ secrets.DOCKER_USERNAME }}/my-client:${{ steps.set_tag.outputs.tag }}
              environment:
                - WDS_SOCKET_PORT=0
            worker:
              image: ${{ secrets.DOCKER_USERNAME }}/my-worker:${{ steps.set_tag.outputs.tag }}
              environment:
                - REDIS_HOST=redis
                - REDIS_PORT=6379
          EOF

      - name: Generate deployment package
        run: zip -r deploy.zip . -x '*.git*'

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v18
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
          aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}
          application_name: multi-docker
          environment_name: Multi-docker-env
          existing_bucket_name: elasticbeanstalk-ap-south-1-376505902044
          region: ap-south-1
          version_label: ${{ steps.set_tag.outputs.tag }}
          deployment_package: deploy.zip
